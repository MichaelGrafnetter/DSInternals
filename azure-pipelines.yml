# Azure Pipelines Build Configuration

pool:
  vmImage: 'VS2017-Win2016'

variables:
  solution: '**/*.sln'
  buildConfiguration: 'Release'

steps:
- task: NuGetToolInstaller@0

- task: NuGetCommand@2
  displayName: 'NuGet Restore Packages'
  inputs:
    command: 'restore'
    restoreSolution: '$(solution)'

# The following task requires the secret variable encodedSNK to contain a BASE64-encoded SNK.
# Its content can be generated using this command:
# [System.IO.File]::ReadAllBytes("DSInternals\Keys\DSInternals.Private.snk")

- task: PowerShell@2
  displayName: 'Restore SNK File (DSInternals.Private.snk)'
  inputs:
    targetType: 'inline'
    script: |
      $key = [System.Convert]::FromBase64String("$(encodedSNK)")
      $workingFolderPath = Resolve-Path -Path .
      $keyFilePath = Join-Path $workingFolderPath "DSInternals.Private.snk"
      [System.IO.File]::WriteAllBytes($keyFilePath, $key)
      Get-ChildItem -Path $workingFolderPath
    workingDirectory: 'Keys'

- task: VSBuild@1
  displayName: 'VSBuild ($(buildConfiguration) x86)'
  inputs:
    solution: '$(solution)'
    platform: 'x86'
    configuration: '$(buildConfiguration)'
    restoreNugetPackages: false

- task: VSBuild@1
  displayName: 'VSBuild ($(buildConfiguration) x64)'
  inputs:
    solution: '$(solution)'
    platform: 'x64'
    configuration: '$(buildConfiguration)'
    restoreNugetPackages: false

- task: NuGetCommand@2
  inputs:
    command: 'pack'
    packagesToPack: '**/*.csproj'
    configuration: '$(BuildConfiguration)'
    packDestination: '$(Build.ArtifactStagingDirectory)'
    includeReferencedProjects: true
    verbosityPack: 'detailed'

# - task: VSTest@2
#   inputs:
#     platform: '$(buildPlatform)'
#     configuration: '$(buildConfiguration)'
