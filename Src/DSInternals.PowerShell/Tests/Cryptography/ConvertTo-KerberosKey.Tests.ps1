
<#
.SYNOPSIS
    This script contains Pester tests for the ConvertTo-KerberosKey cmdlet from the DSInternals PowerShell module.
#>
#Requires -Version 5.1
#Requires -Modules DSInternals,@{ ModuleName = 'Pester'; ModuleVersion = '5.0' }

Describe 'ConvertTo-KerberosKey' {
    It 'should return the correct key when the input is a secure string' {
        [securestring] $testInput = ConvertTo-SecureString 'Pa$$w0rd' -AsPlainText -Force
        ConvertTo-KerberosKey -Password $testInput -Salt 'CONTOSOAdministrator' | Should -HaveCount 4
    }

    It 'Supplemental credentials are serialized properly' {
        [string] $xmlSerializationFile = 'TestDrive:\SupplementalCredentials.xml'
        [string] $hexCredentials = '000000008809000000000000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000500005003200200001005000720069006d006100720079003a004e0054004c004d002d005300740072006f006e0067002d004e0054004f005700460064626533343361626337656632643162313166366136643537666437393636383600a00201005000720069006d006100720079003a004b00650072006200650072006f0073002d004e0065007700650072002d004b006500790073003034303030303030303330303030303030333030303030303230303032303030633030303030303030303130303030303030303030303030303030303030303030303130303030303132303030303030323030303030303065303030303030303030303030303030303030303030303030303130303030303131303030303030313030303030303030303031303030303030303030303030303030303030303030303130303030303033303030303030303830303030303031303031303030303030303030303030303030303030303030303130303030303132303030303030323030303030303031383031303030303030303030303030303030303030303030303130303030303131303030303030313030303030303033383031303030303030303030303030303030303030303030303130303030303033303030303030303830303030303034383031303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303431303034343030343130303534303035353030346430303265303034333030346630303464303037353030373330303635303037323030333030303333303037646266326238323237313934353066633533303531343334626438336361616433613436323462326166316538396461633266353665336438316436663937633362653262636439616533336665643862383338383463643032386532353936326539363765363062643637356561376462663262383232373139343530666335333035313433346264383363616164336134363234623261663165383964616332663536653364383164366639376333626532626364396165333366656438623833383834636430323865323539363265393637653630626436373565612000f80001005000720069006d006100720079003a004b00650072006200650072006f00730030333030303030303031303030313030323030303230303034633030303030303030303030303030303030303030303030333030303030303038303030303030366330303030303030303030303030303030303030303030303330303030303030383030303030303734303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303431303034343030343130303534303035353030346430303265303034333030346630303464303037353030373330303635303037323030333030303333303036326539363765363062643637356561363265393637653630626436373565611000d80002005000610063006b0061006700650073003465303035343030346330303464303032643030353330303734303037323030366630303665303036373030326430303465303035343030346630303537303034363030303030303462303036353030373230303632303036353030373230303666303037333030326430303465303036353030373730303635303037323030326430303462303036353030373930303733303030303030346230303635303037323030363230303635303037323030366630303733303030303030353730303434303036393030363730303635303037333030373430301e00c00301005000720069006d006100720079003a00570044006900670065007300740033313030303131643030303030303030303030303030303030303030303030303033666330316465373131623033333135386130363038343037343538393034373431363466323265653166303435326136373739623432393031613835306163343437393533313466343738363639313362366464663230386236633966323033666330316465373131623033333135386130363038343037343538393034373431363466323265653166303435326136373739623432393031613835306136353165383630313533313961626163366262393430326531663734323166323033666330316465373131623033333135386130363038343037343538393034383863363563336635653232336461366662386638663465326163303463663239653363613966353463656566323431623733303737333566366363656430336335396365613336353464656464653466363463356236373662306665636165303035613437313931353136366563333065383862623837323833353733626639653363613966353463656566323431623733303737333566366363656430333732613561323461326234653337616562616334323639336233303237326331303035613437313931353136366563333065383862623837323833353733626631323137336233363932663337346233303432306262646632346234356539633631303263396561656334333932396536373031313365323532316565663939323438383132306339386637333638653539326561663164613233636661303663353465333139303763363631353431646264303864323362326339613530613461666431643934656636363932333163313462393339326537373937653762336266333936633530353338356566653139363261643930303963373231393538636137303462616534623538303863616639313862343930356165616331393863613730346261653462353830386361663931386234393035616561633139663230346164333262663665343466383837643066666666326437626539633236633432373937373061346565343762633465396231623938633134613832313835366539613133666634313337346432656336326365666234396237306664306634653636393032626236653564363530303963313061656338343762643435383432363833383731376238353831323436353136356262373631366132636463383031623063333762623034643964346364393463343863613634613861366334663632366135353334616337666330333161313736623563383366363800'
        [byte[]] $binaryCredentials = [DSInternals.Common.ByteArrayExtensions]::HexToBinary($hexCredentials)
        [DSInternals.Common.Data.SupplementalCredentials] $credentials = [DSInternals.Common.Data.SupplementalCredentials]::new($binaryCredentials)

        Export-Clixml -InputObject $credentials -Path $xmlSerializationFile
        [DSInternals.Common.Data.SupplementalCredentials] $importedCredentials = Import-Clixml -Path $xmlSerializationFile
        ConvertTo-Hex -Input $importedCredentials.ToByteArray() | Should -Be $hexCredentials
    }
}